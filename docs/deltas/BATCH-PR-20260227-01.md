# Batch: BATCH-PR-20260227-01
Date: 2026-02-27
Source Audit: src-production-readiness-audit-011.md

## Summary
This batch resolves NBRC hard violations and closes cadence/observability gaps by enforcing a single timeout contract, eliminating blocking DNS risk in runtime reconnect paths, adding explicit tick progress reporting with correct idle-yield semantics, and emitting required runtime metrics.

## Findings → Remediation Mapping

### Finding 1 — P0: Silent timeout clamping across runtime tick APIs
- Severity: P0
- Problem: `timeoutMs` is silently clamped to 0 across manager/reactor/transport, violating NBRC timeout contract requirements.
- Dialer impact: Operators believe cadence is honored; runtime ignores timeout, leading to hot-spin or external sleeps and inconsistent behavior.
- Required invariant: NB-30/NB-31 must be enforced end-to-end (no silent clamping).
- NBRC clauses: NB-30, NB-31, NB-01
- Concrete implementation direction:
  - Choose **Contract 1 (Honored Timeout)** per NBRC recommendation.
  - Enforce validated `timeoutMs` range (0..max) in manager/reactor/transport and pass through from worker.
  - Remove silent clamping and replace with explicit validation (reject negatives; clamp or reject > max per contract choice) with deterministic metrics/logging.
- Required acceptance tests:
  - NB-T02 Timeout Contract End-to-End.
  - Unit test: manager/reactor/transport honor non-zero timeout and selector waits measurably.
- Task IDs generated: PR1-P0-01

### Finding 2 — P0: Blocking DNS possible in tick-driven reconnect when TcpTransport used directly
- Severity: P0
- Problem: `TcpTransport::open()` allows hostnames when `enforceIpEndpoints=false` and can trigger blocking DNS resolution inside tick-driven reconnects.
- Dialer impact: Tick loop can block on DNS, violating non-blocking guarantees under load or DNS slowness.
- Required invariant: DNS resolution must not occur in tick/connect paths; hostname mode must require resolver injection.
- NBRC clauses: NB-01, NB-10, NB-11
- Concrete implementation direction:
  - Ensure `TcpTransport` enforces IP-only unless a resolver-prepared IP is provided (or require resolver injection at construction).
  - Make hostname endpoints fail fast with `InvalidConfigurationException` when resolver is absent.
- Required acceptance tests:
  - NB-T03 No DNS in Tick Path (hostname without resolver fails fast).
  - Unit test: `TcpTransport` rejects hostname when `enforceIpEndpoints=true` or resolver is missing.
- Task IDs generated: PR1-P0-02

### Finding 3 — P1: Worker cadence yields blindly; no idle detection or progress summary
- Severity: P1
- Problem: Worker loop sleeps every iteration and tick APIs return void, so idle detection is impossible.
- Dialer impact: Throughput is throttled under load and idle-yield behavior is incorrect per NBRC.
- Required invariant: Worker cadence uses Mode A or Mode B with explicit idle detection based on tick progress summary.
- NBRC clauses: NB-20, NB-21, NB-22
- Concrete implementation direction:
  - Introduce a tick progress summary object (bytes read/written, frames parsed, events dispatched, state transitions, connect attempts).
  - Update `tick()`/`tickAll()` to return progress summary, and have `ListenCommand` yield only when no progress.
  - Prefer Mode A (bounded selector wait) when using Contract 1.
- Required acceptance tests:
  - NB-T01 Idle Loop CPU/Cadence Test.
  - Integration test: progress summary reflects read/write/dispatch activity and idle-yield only when no progress.
- Task IDs generated: PR1-P1-01

### Finding 4 — P2: Missing required runtime observability metrics
- Severity: P2
- Problem: Required metrics (tick_duration_ms, tick_progress, selector_wait_ms, idle_yield_count, etc.) are not emitted.
- Dialer impact: Production observability gaps prevent verifying NBRC compliance.
- Required invariant: Required runtime observability signals must be emitted and non-throwing.
- NBRC clauses: NB-08
- Concrete implementation direction:
  - Emit metrics in manager/reactor/worker with consistent labels (`server_key`, etc.).
  - Ensure metrics are bounded and non-throwing.
- Required acceptance tests:
  - Unit test: metrics collector receives tick_duration_ms and tick_progress.
  - Integration test: selector_wait_ms and idle_yield_count recorded during idle run.
- Task IDs generated: PR1-P2-01

### Finding 5 — P2: Timeout contract messaging inconsistent with worker configuration
- Severity: P2
- Problem: CLI exposes `--tick-timeout-ms` but core APIs clamp timeout to 0, so behavior diverges from documentation.
- Dialer impact: Operators misconfigure cadence; latency expectations are wrong.
- Required invariant: API and CLI semantics match runtime behavior for `timeoutMs`.
- NBRC clauses: NB-30
- Concrete implementation direction:
  - Align CLI option naming/behavior with chosen timeout contract (e.g., pass timeout to `tickAll()` or rename option to idle sleep if Mode B).
  - Update interface docblocks to match contract.
- Required acceptance tests:
  - Unit test: CLI-configured timeout reaches tick implementation and is honored (Contract 1).
- Task IDs generated: PR1-P2-02

## NBRC Clauses Enforced In This Batch
NB-01, NB-08, NB-10, NB-11, NB-20, NB-21, NB-22, NB-30, NB-31

## Acceptance Criteria For Entire Batch
- A single timeout contract is enforced end-to-end with explicit validation (no silent clamping).
- Hostname endpoints cannot trigger blocking DNS in tick/connect paths; resolver injection is mandatory where hostname mode is permitted.
- Worker cadence uses explicit idle detection with progress summaries; no blind sleeps.
- Required runtime metrics are emitted and non-throwing.
- All required NBRC tests (NB-T01..NB-T03, NB-T02) pass under PHPUnit.
