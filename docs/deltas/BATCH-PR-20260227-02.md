# Batch: BATCH-PR-20260227-02
Date: 2026-02-27
Source Audit: src-production-readiness-audit-012.md

## Summary
This batch closes the remaining high-severity NBRC drifts by enforcing strict single-selector behavior in `tickAll()` failure paths and making runtime-path logging failure-proof when custom/injected loggers throw.

## Findings → Remediation Mapping

### Finding 1 — P1: NB-02 strict selector-count violation on selector-failure path
- Severity: P1
- Problem description: `Reactor::tick()` may execute multiple selector calls in a single `tickAll()` invocation when the main `stream_select()` fails.
- Dialer impact: Contract drift under failure conditions undermines deterministic runtime behavior and increases selector churn.
- Required invariant: Exactly one selector call per `tickAll()` invocation, including failure paths.
- NBRC clause(s): NB-02
- Concrete implementation direction:
  - Remove per-transport `stream_select(..., 0, 0)` probe loop from `handleStreamSelectFailure()`.
  - On selector failure, log structured per-server failure context using non-select resource validation and close invalid/affected transports deterministically.
  - Preserve node isolation: failure handling for one server must not prevent others from being processed in future ticks.
- Required acceptance tests:
  - Unit test for `Reactor` asserting only one selector operation occurs per `tick()` invocation, including failure scenarios.
  - Integration test asserting selector-failure handling remains isolated and non-blocking.
- Task IDs generated: PR2-P1-01

### Finding 2 — P1: NB-51 containment gap for injected logger failures in runtime paths
- Severity: P1
- Problem description: Several runtime logging call sites invoke logger methods without containment wrappers; injected logger exceptions can bubble out.
- Dialer impact: Faulty logger backends can break tick processing and violate runtime stability guarantees.
- Required invariant: Logger failures must never break runtime loop execution.
- NBRC clause(s): NB-51
- Concrete implementation direction:
  - Introduce a small non-throwing logging helper (or dedicated wrapper) used by manager/reactor/client runtime paths.
  - Replace direct tick-path `$this->logger->warning/error/info(...)` calls with guarded equivalents.
  - Ensure guard preserves mandatory structured fields (`server_key`, `action_id`, `queue_depth` where applicable).
- Required acceptance tests:
  - Unit tests with a throwing logger stub proving manager/reactor/client tick paths do not throw.
  - Integration regression test where logging failures occur during reconnect/event processing without interrupting loop progress.
- Task IDs generated: PR2-P1-02

## NBRC Clauses Enforced In This Batch
NB-02, NB-51

## Acceptance Criteria For Entire Batch
- `tickAll()` executes exactly one selector operation per invocation in both success and failure paths.
- Selector failures remain isolated and do not trigger secondary selector probes.
- Runtime-path logging failures are fully contained and cannot break tick processing.
- PHPUnit coverage includes deterministic regressions for single-selector enforcement and logger-failure containment.
