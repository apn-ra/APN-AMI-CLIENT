# Tasks: BATCH-PR-20260227-02
Date: 2026-02-27
Source Audit: src-production-readiness-audit-012.md
Source Delta: docs/deltas/BATCH-PR-20260227-02.md

## Phase P0 (Blockers)
None.

## Phase P1 (High)
- [x] `PR2-P1-01` — Enforce single-selector runtime behavior on reactor failure path
  - `batch:` BATCH-PR-20260227-02
  - `severity:` P1
  - `addresses_audit:` src-production-readiness-audit-012.md:P1 — NB-02 strict selector-count violation on selector-failure path
  - `enforces_nbrc:` NB-02
  - `targets:` src/Transport/Reactor.php, tests/Unit/Transport/ReactorTest.php, tests/Integration/TransportSelectorFailureTest.php
  - `required_changes:`
  - Remove per-transport probe `stream_select` calls from selector-failure handling.
  - Replace probe-based failure classification with deterministic non-selector validation and structured logging.
  - Keep per-node isolation and bounded failure handling semantics.
  - `acceptance_criteria:`
  - Exactly one selector operation occurs per `tick()`/`tickAll()` invocation, including selector failure scenarios.
  - Selector failure handling remains non-blocking and does not introduce starvation.
  - Existing selector-failure behavior remains observable with structured `server_key` context.
  - `required_tests:`
  - tests/Unit/Transport/ReactorTest.php: add assertion for single-selector behavior under failure.
  - tests/Integration/TransportSelectorFailureTest.php: verify failure isolation without additional selector probes.
  - `invariants_must_hold:`
  - Single selector per `tickAll()`.
  - No blocking connect/close/DNS in runtime tick paths.
  - Multi-server fairness under capped budgets.

- [x] `PR2-P1-02` — Contain logger exceptions across runtime tick paths
  - `batch:` BATCH-PR-20260227-02
  - `severity:` P1
  - `addresses_audit:` src-production-readiness-audit-012.md:P1 — NB-51 containment gap for injected logger failures in runtime paths
  - `enforces_nbrc:` NB-51
  - `targets:` src/Cluster/AmiClientManager.php, src/Transport/Reactor.php, src/Core/AmiClient.php, tests/Unit/Core/AmiClientTest.php, tests/Unit/Transport/ReactorTest.php, tests/Unit/Cluster/AmiClientManagerTest.php
  - `required_changes:`
  - Introduce and use non-throwing logger wrapper/helper in runtime paths.
  - Guard all tick-path logging call sites against logger backend exceptions.
  - Preserve structured logging fields (`server_key`, `action_id`, `queue_depth`) where applicable.
  - `acceptance_criteria:`
  - Throwing logger implementations do not bubble exceptions from manager/reactor/client tick paths.
  - Runtime loop continues processing after logging failures.
  - Log-failure containment itself is non-throwing and deterministic.
  - `required_tests:`
  - tests/Unit/Cluster/AmiClientManagerTest.php: throw-on-log stub does not break `tickAll()`.
  - tests/Unit/Transport/ReactorTest.php: throw-on-log stub does not break `tick()`.
  - tests/Unit/Core/AmiClientTest.php: throw-on-log stub does not break `processTick()`.
  - `invariants_must_hold:`
  - Tick loop remains non-blocking.
  - Listener and node isolation continue to hold.
  - Logging failure cannot terminate runtime loop execution.

## Phase P2 (Medium)
None.

## Phase P3 (Low)
None.
