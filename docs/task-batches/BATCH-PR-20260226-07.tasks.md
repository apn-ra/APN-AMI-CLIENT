## Append: BATCH-PR-20260226-07

### Phase P0 (Blockers)
- [x] PR7-P0-01 (BATCH-PR-20260226-07) Enforce session-boundary write-buffer purge on non-graceful close
  Severity: P0
  Target files/classes: `src/Transport/TcpTransport.php`, `src/Transport/WriteBuffer.php`, `src/Core/AmiClient.php`
  Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-07) -> P0 - Stale outbound bytes can leak across reconnect session boundaries
  Acceptance criteria:
- Non-graceful close path clears or epoch-invalidates unsent write-buffer bytes before reconnect is attempted.
- Reconnect path cannot flush bytes that were queued before the close event.
- Graceful shutdown behavior remains explicit and deterministic.
  Required tests to add:
- PHPUnit integration test: disconnect with pending writes, reconnect, and verify no stale action bytes are emitted to the new session. Run with `vendor/bin/phpunit`.
- PHPUnit unit test: non-graceful close invokes write-buffer clear/epoch invalidation exactly once and buffer depth becomes zero for reconnect path. Run with `vendor/bin/phpunit`.
  Invariants that must remain true:
- Pending actions are deterministically failed on disconnect.
- No cross-session action replay after reconnect.

### Phase P1 (High)
- [x] PR7-P1-01 (BATCH-PR-20260226-07) Replace synchronous tick-path stdout logging with bounded non-blocking sink
  Severity: P1
  Target files/classes: `src/Core/Logger.php`, `src/Core/AmiClient.php`, `src/Core/Contracts/MetricsCollectorInterface.php`
  Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-07) -> P1 - Tick-path logging must not perform synchronous stdout I/O
  Acceptance criteria:
- Tick-path logging no longer uses direct blocking stdout `echo` writes.
- Logger sink has bounded queue/capacity with deterministic drop behavior.
- Log-drop counter is incremented when sink capacity is exceeded.
  Required tests to add:
- PHPUnit unit test: sink backpressure/drop path increments log-drop counter and does not throw. Run with `vendor/bin/phpunit`.
- PHPUnit integration test: callback/listener exception logging under blocked sink does not block tick progression for subsequent processing. Run with `vendor/bin/phpunit`.
  Invariants that must remain true:
- Tick loop remains non-blocking under logging backpressure.
- Listener exceptions cannot break dispatch loops.

- [x] PR7-P1-02 (BATCH-PR-20260226-07) Add event-drop log coalescing and interval rate limit
  Severity: P1
  Target files/classes: `src/Core/AmiClient.php`, `src/Core/EventQueue.php`, `src/Core/ClientOptions.php`
  Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-07) -> P1 - Per-drop warning logs create amplification storms under queue pressure
  Acceptance criteria:
- Event-drop warnings are emitted as interval summaries with `dropped_delta`, `queue_depth`, and `server_key`.
- Per-event drop warnings are removed from hot path.
- Precise dropped-event counters remain monotonic and accurate.
  Required tests to add:
- PHPUnit unit test: burst drop scenario emits at most one warning per configured interval while dropped counter equals total drops. Run with `vendor/bin/phpunit`.
- PHPUnit integration test: sustained flood does not exceed configured logging rate budget and processing continues. Run with `vendor/bin/phpunit`.
  Invariants that must remain true:
- Queue drops remain observable.
- Drop logging cannot dominate tick time under burst load.

- [x] PR7-P1-03 (BATCH-PR-20260226-07) Eliminate busy-spin in Laravel `ami:listen` runtime loop
  Severity: P1
  Target files/classes: `src/Laravel/Commands/ListenCommand.php`, `config/ami-client.php`, `tests/Integration/*`
  Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-07) -> P1 - Laravel listener loop busy-spins without blocking/yield
  Acceptance criteria:
- Worker loop uses bounded blocking tick (`tickAll(10-50)` or configured equivalent) or deterministic idle sleep/yield path.
- Loop cadence is configurable and validated at startup.
- Idle loop no longer consumes near-100% CPU in normal no-event conditions.
  Required tests to add:
- PHPUnit integration test: idle listen loop executes bounded iterations with configured wait and does not busy-spin. Run with `vendor/bin/phpunit`.
- PHPUnit unit test: invalid loop cadence config is rejected with typed configuration exception. Run with `vendor/bin/phpunit`.
  Invariants that must remain true:
- Core remains framework-agnostic (no `Illuminate\*` outside `src/Laravel/`).
- Runtime loop behavior is deterministic and bounded.

### Phase P2 (Medium)
- [x] PR7-P2-01 (BATCH-PR-20260226-07) Enforce explicit non-blocking timeout semantics at runtime API boundary
  Severity: P2
  Target files/classes: `src/Cluster/AmiClientManager.php`, `src/Transport/Reactor.php`, `src/Transport/TcpTransport.php`, `src/Core/ClientOptions.php`
  Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-07) -> P2 - Non-blocking runtime contract is not enforced at API boundary
  Acceptance criteria:
- Runtime-critical APIs reject or clamp blocking timeout inputs in production non-blocking mode.
- If blocking mode is supported, it is exposed as explicit separate API path and cannot be used accidentally by runtime loop.
- Timeout behavior is documented and configuration-validated.
  Required tests to add:
- PHPUnit unit test: runtime non-blocking mode with `timeoutMs > 0` is clamped/rejected deterministically. Run with `vendor/bin/phpunit`.
- PHPUnit integration test: `tickAll()` in production mode keeps non-blocking behavior across multiple nodes when caller passes non-zero timeout. Run with `vendor/bin/phpunit`.
  Invariants that must remain true:
- Tick loop fully non-blocking in production runtime mode.
- Multi-server fairness under per-tick budgets remains intact.

### Phase P3 (Low)
None.