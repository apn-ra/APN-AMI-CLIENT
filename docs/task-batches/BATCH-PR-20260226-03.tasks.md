## Append: BATCH-PR-20260226-03

### Phase P1
1. [x] PR3-P1-01 (BATCH-PR-20260226-03) Remove hidden blocking from close() and redesign shutdown as non-blocking state machine. Severity: P1. Targets: `src/Core/AmiClient.php` (close/shutdown path), any shutdown helpers. Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-03): Non-Blocking Shutdown + Correlation Transactionality + Callback Isolation + Metrics Wiring. Acceptance: close() returns immediately (no internal tick/select wait); shutdown completes via normal tick progression or bounded deadline. Tests: close() does not block; tick loop continues under simulated churn.
2. [x] PR3-P1-02 (BATCH-PR-20260226-03) Define/implement production hostname policy (prefer IP or bootstrap pre-resolution; never resolve in tick). Severity: P1. Targets: `src/Transport/TcpTransport.php` connect path; options/docs. Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-03): Non-Blocking Shutdown + Correlation Transactionality + Callback Isolation + Metrics Wiring. Acceptance: no hostname resolution occurs inside tick/connect hot path OR endpoints require IP in production mode. Tests: connecting with hostname does not block tick (use test double / documented policy test).
3. [x] PR3-P1-03 (BATCH-PR-20260226-03) Make sendInternal transactional: rollback/fail pending action if transport->send() throws (backpressure). Severity: P1. Targets: `src/Core/AmiClient.php` sendInternal; `src/Correlation/CorrelationRegistry.php` rollback API. Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-03): Non-Blocking Shutdown + Correlation Transactionality + Callback Isolation + Metrics Wiring. Acceptance: no orphan pending action exists after send failure; typed exception returned to caller with actionable context. Tests: transport send throws -> correlation registry count unchanged / actionId removed; no false timeout noise for rolled-back action.
4. [x] PR3-P1-04 (BATCH-PR-20260226-03) Isolate pending completion callbacks: exceptions in user callbacks do not tear down tick/connection. Severity: P1. Targets: `src/Correlation/PendingAction.php` notify(); call sites in AmiClient processing loop. Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-03): Non-Blocking Shutdown + Correlation Transactionality + Callback Isolation + Metrics Wiring. Acceptance: callback exceptions are caught, logged, and counted; client continues processing subsequent frames/events. Tests: callback throws -> connection remains healthy; subsequent action completes normally.

### Phase P2
1. [x] PR3-P2-01 (BATCH-PR-20260226-03) Add MetricsCollectorInterface injection to AmiClientManager and propagate through createClient() stack. Severity: P2. Targets: `src/Cluster/AmiClientManager.php`; `src/Core/AmiClient.php`; `src/Core/EventQueue.php`; `src/Health/ConnectionManager.php`. Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-03): Non-Blocking Shutdown + Correlation Transactionality + Callback Isolation + Metrics Wiring. Acceptance: default wiring supports non-null metrics collector injection; counters increment in relevant paths (drops/backpressure/reconnect/callback_exception). Tests: manager with test metrics collector sees increments for a simulated drop/backpressure event.
2. [x] PR3-P2-02 (BATCH-PR-20260226-03) Validate EventQueue capacity >= 1 and throw typed config exception on invalid value. Severity: P2. Targets: `src/Core/EventQueue.php`. Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-03): Non-Blocking Shutdown + Correlation Transactionality + Callback Isolation + Metrics Wiring. Acceptance: capacity <= 0 fails fast with typed exception. Tests: constructing with 0/negative capacity throws expected exception.

### Phase P3
1. [x] PR3-P3-01 (BATCH-PR-20260226-03) Replace shutdown/logoff swallow with structured debug/warn telemetry. Severity: P3. Targets: `src/Core/AmiClient.php` logoff/close exception handling. Plan ref: Delta 2026-02-26 (BATCH-PR-20260226-03): Non-Blocking Shutdown + Correlation Transactionality + Callback Isolation + Metrics Wiring. Acceptance: swallow paths log structured context (server_key, reason, exception class/message where safe). Tests: optional (if logging tests exist); otherwise verify via code-level assertions / documented behavior.