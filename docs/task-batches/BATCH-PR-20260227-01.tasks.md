# Tasks: BATCH-PR-20260227-01
Date: 2026-02-27
Source Audit: src-production-readiness-audit-011.md
Source Delta: docs/deltas/BATCH-PR-20260227-01.md

## Phase P0 (Blockers)
- [x] PR1-P0-01 — Enforce honored `timeoutMs` contract end-to-end (no silent clamping)
  `batch:` BATCH-PR-20260227-01
  `severity:` P0
  `addresses_audit:` src-production-readiness-audit-011.md:P0 — Silent timeout clamping across runtime tick APIs
  `enforces_nbrc:` NB-30, NB-31, NB-01
  `targets:` src/Cluster/AmiClientManager.php, src/Transport/Reactor.php, src/Transport/TcpTransport.php, src/Core/Contracts/AmiClientInterface.php, src/Core/Contracts/TransportInterface.php, src/Laravel/Commands/ListenCommand.php
  `required_changes:`
  - Choose Contract 1 (Honored Timeout) with explicit max range.
  - Replace silent clamping with validation (reject negatives, clamp or reject > max per contract).
  - Pass validated timeout into reactor/transport and use it in selector waits.
  `acceptance_criteria:`
  - `tick()`/`tickAll()` honor non-zero timeout with measurable selector waits.
  - Invalid timeout values are rejected deterministically (typed exceptions where applicable).
  - No silent clamping to 0 occurs anywhere in runtime path.
  `required_tests:`
  - tests/Unit/*: verify timeout validation and selector wait behavior.
  - tests/Integration/*: NB-T02 timeout contract end-to-end.
  `invariants_must_hold:`
  - No blocking DNS/connect/close in tick path.
  - Single selector per tickAll.

- [x] PR1-P0-02 — Eliminate blocking DNS risk in tick-driven reconnect paths
  `batch:` BATCH-PR-20260227-01
  `severity:` P0
  `addresses_audit:` src-production-readiness-audit-011.md:P0 — Blocking DNS possible in tick-driven reconnect when TcpTransport used directly
  `enforces_nbrc:` NB-01, NB-10, NB-11
  `targets:` src/Transport/TcpTransport.php, src/Cluster/AmiClientManager.php, src/Cluster/ConfigLoader.php
  `required_changes:`
  - Require pre-resolved IPs for `TcpTransport` or inject resolver explicitly; fail fast if hostname is supplied without resolver.
  - Ensure hostname mode never triggers DNS inside tick/connect paths.
  `acceptance_criteria:`
  - Hostname endpoints fail fast without resolver (typed exception).
  - No blocking DNS occurs in any tick-driven connect/reconnect path.
  `required_tests:`
  - tests/Integration/*: NB-T03 No DNS in Tick Path.
  - tests/Unit/Transport/*: hostname endpoint handling per policy.
  `invariants_must_hold:`
  - Non-blocking runtime paths remain DNS-free.
  - Session-boundary write buffers purge on non-graceful reconnect.

## Phase P1 (High)
- [x] PR1-P1-01 — Add tick progress summary and idle-aware cadence
  `batch:` BATCH-PR-20260227-01
  `severity:` P1
  `addresses_audit:` src-production-readiness-audit-011.md:P1 — Worker cadence yields blindly; no idle detection or progress summary
  `enforces_nbrc:` NB-20, NB-21, NB-22
  `targets:` src/Core/AmiClient.php, src/Cluster/AmiClientManager.php, src/Laravel/Commands/ListenCommand.php, src/Transport/Reactor.php
  `required_changes:`
  - Introduce a progress summary structure returned by `tick()`/`tickAll()`.
  - Update worker cadence to yield only when no progress.
  - Use Mode A selector wait with timeout if Contract 1 is chosen.
  `acceptance_criteria:`
  - Worker loop does not yield under active I/O or dispatch progress.
  - Idle loop yields deterministically with bounded cadence (no hot-spin).
  `required_tests:`
  - tests/Integration/*: NB-T01 Idle Loop CPU/Cadence Test.
  - tests/Unit/*: progress summary reflects read/write/dispatch activity.
  `invariants_must_hold:`
  - Tick loop remains non-blocking.
  - Multi-server fairness maintained.

## Phase P2 (Medium)
- [x] PR1-P2-01 — Emit required NBRC runtime observability metrics
  `batch:` BATCH-PR-20260227-01
  `severity:` P2
  `addresses_audit:` src-production-readiness-audit-011.md:P2 — Missing required runtime observability metrics
  `enforces_nbrc:` NB-08
  `targets:` src/Cluster/AmiClientManager.php, src/Transport/Reactor.php, src/Laravel/Commands/ListenCommand.php
  `required_changes:`
  - Emit tick_duration_ms, tick_progress, selector_wait_ms, idle_yield_count, and related counters with server_key labels.
  - Ensure metrics emission is non-throwing.
  `acceptance_criteria:`
  - Metrics collector receives required signals on active and idle ticks.
  - Missing-metric regressions are covered by tests.
  `required_tests:`
  - tests/Unit/*: metrics emitted on tick.
  - tests/Integration/*: selector_wait_ms and idle_yield_count recorded during idle loop.
  `invariants_must_hold:`
  - Logging remains non-throwing.
  - Tick performance remains bounded.

- [x] PR1-P2-02 — Align CLI timeout option with runtime timeout contract
  `batch:` BATCH-PR-20260227-01
  `severity:` P2
  `addresses_audit:` src-production-readiness-audit-011.md:P2 — Timeout contract messaging inconsistent with worker configuration
  `enforces_nbrc:` NB-30
  `targets:` src/Laravel/Commands/ListenCommand.php, src/Core/Contracts/AmiClientInterface.php
  `required_changes:`
  - Ensure `--tick-timeout-ms` is passed into tick APIs and honored per Contract 1 (or rename to idle sleep if Contract 2 were chosen).
  - Update docblocks to match enforced behavior.
  `acceptance_criteria:`
  - CLI-configured timeout is honored end-to-end.
  - Documentation and runtime behavior match.
  `required_tests:`
  - tests/Unit/*: CLI timeout wiring reaches tickAll/tick.
  `invariants_must_hold:`
  - Tick loop remains non-blocking.
  - No silent timeout clamping.

## Phase P3 (Low)
None.
